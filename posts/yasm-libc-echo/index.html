<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Printf, scanf in assembler.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>0x07 Yasm: Echo with libc. | Death Of Rats</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://death-of-rats.github.io/posts/yasm-libc-echo/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="description" itemprop="description" content="Printf, scanf in assembler.">
<meta name="author" content="death-of-rats">
<link rel="prev" href="../yasm-hello-world/" title="0x06 Yasm: Hello World! ELF64" type="text/html">
<link rel="next" href="../gdb-qemu-booting/" title="0x08 Debug booting code in QEMU" type="text/html">
<meta property="og:site_name" content="Death Of Rats">
<meta property="og:title" content="0x07 Yasm: Echo with libc.">
<meta property="og:url" content="https://death-of-rats.github.io/posts/yasm-libc-echo/">
<meta property="og:description" content="Printf, scanf in assembler.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-04-29T00:00:00Z">
<meta property="article:tag" content="asm">
<meta property="article:tag" content="re">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://death-of-rats.github.io/">

            <span id="blog-title">Death Of Rats</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">0x07 Yasm: Echo with libc.</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    death-of-rats
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2019-04-29T00:00:00Z" itemprop="datePublished" title="2019-04-29 00:00">2019-04-29 00:00</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/yasm-libc-echo.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>Let us write something with standard C functions like <em>printf</em> or <em>scanf</em>. What
I plan to learn from this is how to link the program with libc and do a little
refactor to program structure. </p>
<!-- TEASER_END -->

<p>The mini topic for this post is 'echo'. We want to read some string and print
it. To do this with libc functions one needs to let known which functions are
external. For this purpose, we can use <code>extern</code>. </p>
<p>I'm still using <strong>ld</strong>. This is the reason why I use <em>_start</em> label and have to
finish the program with <code>syscall</code> instead of, for example, <code>ret</code>.
But now <em>_start</em> function calls  <em>main</em>. <em>main</em> do full stack frame and do
'echo' job.</p>
<pre class="code literal-block"><span></span><span class="c">; asm01.s - scanf version</span>
<span class="nf">global</span> <span class="no">_start</span>
<span class="nf">extern</span> <span class="no">printf</span>
<span class="nf">extern</span> <span class="no">scanf</span>

<span class="nf">section</span> <span class="no">.data</span>
    <span class="nf">msg</span>     <span class="no">db</span>  <span class="err">"</span><span class="no">write</span> <span class="no">something</span> <span class="no">for</span> <span class="no">echo</span><span class="p">:</span><span class="err">"</span><span class="p">,</span><span class="mi">0x0a</span><span class="p">,</span><span class="mi">0x00</span>
    <span class="nf">frm</span>     <span class="no">db</span>  <span class="err">"%</span><span class="mi">127</span><span class="no">s</span><span class="err">\</span><span class="no">n</span><span class="err">"</span><span class="p">,</span><span class="mi">0x00</span>
    <span class="nf">frm2</span>    <span class="no">db</span>  <span class="err">"</span><span class="nv">%s</span><span class="err">"</span><span class="p">,</span><span class="mi">0x00</span>
    <span class="nf">emg</span>     <span class="no">db</span>  <span class="mi">0x0a</span><span class="p">,</span><span class="err">"</span><span class="no">the</span> <span class="no">end...</span><span class="err">"</span><span class="p">,</span><span class="mi">0x0a</span><span class="p">,</span><span class="mi">0x00</span>

<span class="nf">section</span> <span class="no">.text</span>
<span class="nl">main:</span>
    <span class="nf">push</span> <span class="no">rbp</span>
    <span class="nf">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x80</span> 

    <span class="no">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">msg</span><span class="p">]</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">frm</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">call</span> <span class="no">scanf</span>

    <span class="nf">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">frm2</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">emg</span><span class="p">]</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">leave</span>
    <span class="nf">ret</span>

<span class="nl">_start:</span>
    <span class="nf">call</span> <span class="no">main</span>

<span class="nl">_exit:</span>
    <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span>
    <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nf">syscall</span>
</pre>


<p>To build this I created <strong>Makefile</strong>. In yasm section <code>-g dwarf2</code> is for
debug information. Linker line is also longer. It linked additional <em>c</em> library
(<code>-lc</code>). But this was not enough. When I tried to run a program linked in
this way I've got: 'no such file or directory'. I've read somewhere that <strong>ld</strong>
has some problems with libc on some distros. The way to solve this is to link
dynamically real lib. </p>
<pre class="code literal-block"><span></span><span class="c1"># Makefile</span>
all: prog

prog: asm01.o
    ld -dynamic-linker /lib64/ld-linux-x86-64.so.2 -lc -o asm01 asm01.o

asm01.o: asm01.s
    yasm -f elf64 -g dwarf2 asm01.s

clean:
    rm -rf asm01.o
    rm -rf asm01
</pre>


<pre class="code literal-block"><span></span>$ ./asm01 
write something <span class="k">for</span> echo:
Echo is a nice <span class="k">function</span>.... print whatever you put in...
Echo
the end...
</pre>


<p>Hmmm, ok something goes wrong... Ah, yes, <code>%s</code> reads string to a first white
character. Not what I intended. First I go for <em>fgets</em>. But it needs <em>FILE*</em>
structure for <strong>stdin</strong>. I didn't want to handle standard descriptions
so I have changed my mind to <em>read</em>.  So change <em>scanf</em> to <em>read</em>.</p>
<pre class="code literal-block"><span></span><span class="c">; asm01.s</span>
<span class="nf">global</span> <span class="no">_start</span>
<span class="nf">extern</span> <span class="no">printf</span>
<span class="nf">extern</span> <span class="no">scanf</span>
<span class="nf">extern</span> <span class="no">read</span>

<span class="nf">section</span> <span class="no">.data</span>
    <span class="nf">msg</span>     <span class="no">db</span>  <span class="err">"</span><span class="no">write</span> <span class="no">something</span> <span class="no">for</span> <span class="no">echo</span><span class="p">:</span><span class="err">"</span><span class="p">,</span><span class="mi">0x0a</span><span class="p">,</span><span class="mi">0x00</span>
    <span class="nf">frm</span>     <span class="no">db</span>  <span class="err">"</span><span class="nv">%s</span><span class="err">"</span><span class="p">,</span><span class="mi">0x00</span>
    <span class="nf">emg</span>     <span class="no">db</span>  <span class="err">"</span><span class="no">the</span> <span class="no">end...</span><span class="err">"</span><span class="p">,</span><span class="mi">0x0a</span><span class="p">,</span><span class="mi">0x00</span>

<span class="nf">section</span> <span class="no">.text</span>
<span class="nl">main:</span>
    <span class="nf">push</span> <span class="no">rbp</span>
    <span class="nf">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x80</span> 

    <span class="no">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">msg</span><span class="p">]</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">0x80</span>
    <span class="nf">call</span> <span class="no">read</span>

    <span class="nf">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">frm</span><span class="p">]</span>
    <span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">lea</span> <span class="no">rdi</span><span class="p">,</span> <span class="p">[</span><span class="no">emg</span><span class="p">]</span>
    <span class="nf">call</span> <span class="no">printf</span>

    <span class="nf">leave</span>
    <span class="nf">ret</span>

<span class="nl">_start:</span>
    <span class="nf">call</span> <span class="no">main</span>

<span class="nl">_exit:</span>
    <span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">60</span>
    <span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span>
    <span class="nf">syscall</span>
</pre>


<p>Ok, this is what I want. And <strong>Makefile</strong> works like a charm...</p>
<p> 
<strong>...SQUEAK!</strong></p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/asm/" rel="tag">asm</a></li>
            <li><a class="tag p-category" href="../../categories/re/" rel="tag">re</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../yasm-hello-world/" rel="prev" title="0x06 Yasm: Hello World! ELF64">Previous post</a>
            </li>
            <li class="next">
                <a href="../gdb-qemu-booting/" rel="next" title="0x08 Debug booting code in QEMU">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="death-of-rats-github-io",
            disqus_url="https://death-of-rats.github.io/posts/yasm-libc-echo/",
        disqus_title="0x07 Yasm: Echo with libc.",
        disqus_identifier="cache/posts/yasm-libc-echo.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="death-of-rats-github-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2019         death-of-rats - powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br><img src="https://travis-ci.org/death-of-rats/death-of-rats.github.io.svg?branch=source"></footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('a.reference:not(.islink)', {
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    baguetteBox.run('img:not(.islink)', {
        captions: function(element) {
            return element.alt;
    }});
    </script>
</body>
</html>
