<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Writeup on easy reverse engineering challenge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Icon 2018 CTF third challenge | Death Of Rats</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://death-of-rats.github.io/posts/icon_2018_ctf_third_challenge/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="description" itemprop="description" content="Writeup on easy reverse engineering challenge">
<meta name="author" content="death-of-rats">
<link rel="prev" href="../cpprest-listener/" title="0x04 cpprest listener" type="text/html">
<link rel="next" href="../how-my-shell-mess-with-me/" title="How my shell mess with me" type="text/html">
<meta property="og:site_name" content="Death Of Rats">
<meta property="og:title" content="Icon 2018 CTF third challenge">
<meta property="og:url" content="https://death-of-rats.github.io/posts/icon_2018_ctf_third_challenge/">
<meta property="og:description" content="Writeup on easy reverse engineering challenge">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-09-14T00:00:00+02:00">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="icon">
<meta property="article:tag" content="re">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="writeups">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://death-of-rats.github.io/">

            <span id="blog-title">Death Of Rats</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Icon 2018 CTF third challenge</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    death-of-rats
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-09-14T00:00:00+02:00" itemprop="datePublished" title="2018-09-14 00:00">2018-09-14 00:00</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/icon_2018_ctf_third_challenge.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>The third challenge is a reverse engineering problem. The zipped package contains 3 files:</p>
<pre class="code literal-block"><span></span>crackme_baby
crackme.py
run.sh
</pre>


<p>Python file contains definitions of simple math operations (add, sub, mul, div2, mod, inf). Let us
 disassemble crackme_baby file.
<!-- TEASER_END --></p>
<p>Main function shows us that 2 long variables are in play, <code>d1 = 25052671110843108</code> 
 and <code>d2 = 16420105858350620421142892712</code>. They are passed to <code>calc_flag__object___object</code> to calculate 
value for the flag. This value is hashed with sha256 and print in format flag{<em>hashed_value</em>}.</p>
<pre class="code literal-block"><span></span><span class="nf">.0x000021c3</span>      <span class="nv">push</span> <span class="nb">rbp</span>                    <span class="c1">; main(int argc, char** argv)</span>
<span class="nf">.0x000021c4</span>      <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
<span class="nf">.0x000021c7</span>      <span class="nv">push</span> <span class="nb">rbx</span>
<span class="nf">.0x000021c8</span>      <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x88</span>
<span class="nf">.0x000021cf</span>      <span class="nv">mov</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">local_84h</span><span class="p">],</span> <span class="nb">edi</span>  <span class="c1">; argc</span>
<span class="nf">.0x000021d5</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_90h</span><span class="p">],</span> <span class="nb">rsi</span>  <span class="c1">; argv</span>
<span class="nf">.0x000021dc</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="nb">fs</span><span class="p">:[</span><span class="mh">0x28</span><span class="p">]</span>    <span class="c1">; [0x28:8]=0x6108 ; '('</span>
<span class="nf">.0x000021e5</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_18h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x000021e9</span>      <span class="nv">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
<span class="nf">.0x000021eb</span>      <span class="nv">call</span> <span class="nv">sym.imp.Py_Initialize</span>
<span class="nf">.0x000021f0</span>      <span class="nv">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xa</span>
<span class="nf">.0x000021f5</span>      <span class="nv">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="mi">0</span>
<span class="nf">.0x000021fa</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.25052671110843108</span> <span class="c1">; 0x2aa0 ; "25052671110843108"</span>
<span class="nf">.0x00002201</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_FromString</span>       <span class="c1">; create python long object</span>
<span class="nf">.0x00002206</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_78h</span><span class="p">],</span> <span class="nb">rax</span>           <span class="c1">; here we have d1</span>
<span class="nf">.0x0000220a</span>      <span class="nv">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xa</span>
<span class="nf">.0x0000220f</span>      <span class="nv">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="mi">0</span>
<span class="nf">.0x00002214</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.16420105858350620421142892712</span> <span class="c1">; 0x2ab2 ; "16420105858350620421142892712"</span>
<span class="nf">.0x0000221b</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_FromString</span>
<span class="nf">.0x00002220</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">],</span> <span class="nb">rax</span>           <span class="c1">; here we have d2</span>
<span class="nf">.0x00002224</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">]</span>
<span class="nf">.0x00002228</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_78h</span><span class="p">]</span>
<span class="nf">.0x0000222c</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x0000222f</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002232</span>      <span class="nv">call</span> <span class="nv">sym.calc_flag__object___object</span> <span class="c1">; compute the value for the flag</span>
<span class="nf">.0x00002237</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x0000223b</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.flag</span><span class="p">:</span><span class="nv">_flag</span> <span class="c1">; 0x2ad0 ; "flag: flag{"  </span>
<span class="nf">.0x00002242</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">obj._ZSt4cout__GLIBCXX_3.4</span> <span class="c1">; 0x204020</span>
<span class="nf">.0x00002249</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____charconst</span>
<span class="nf">.0x0000224e</span>      <span class="nv">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002251</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">]</span> <span class="c1">; get computed value</span>
<span class="nf">.0x00002255</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002258</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_AsLong</span> <span class="c1">; convert Python object to long</span>
<span class="nf">.0x0000225d</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002260</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_60h</span><span class="p">]</span>
<span class="nf">.0x00002264</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x00002267</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000226a</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">to_string_long</span> <span class="c1">; long -&gt; string</span>
<span class="nf">.0x0000226f</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span> <span class="c1">; buffer for sha256 result</span>
<span class="nf">.0x00002273</span>      <span class="nv">lea</span> <span class="nb">rdx</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_60h</span><span class="p">]</span> <span class="c1">; string with the computed long value</span>
<span class="nf">.0x00002277</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x0000227a</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000227d</span>      <span class="nv">call</span> <span class="nv">sym.sha256_std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">basic_string_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char</span>
<span class="nf">.0x00002282</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span> <span class="c1">; we will print sha256 hash</span>
<span class="nf">.0x00002286</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002289</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rbx</span>
<span class="nf">.0x0000228c</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">basic_string_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char__const</span>
<span class="nf">.0x00002291</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002adc</span><span class="p">]</span> <span class="c1">; "}" </span>
<span class="nf">.0x00002298</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000229b</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____charconst</span>
<span class="nf">.0x000022a0</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rax</span>
                  <span class="nf">...</span>
</pre>


<p>So it's time to look closer at function <code>calc_flag__object___object</code>. First instructions just load <code>crackme.py</code> 
and import math functions: </p>
<pre class="code literal-block"><span></span><span class="nf">.0x00001e83</span>      <span class="nv">push</span> <span class="nb">rbp</span>                               
<span class="nf">.0x00001e84</span>      <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>                
<span class="nf">.0x00001e87</span>      <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x70</span>               <span class="c1">; 'p'</span>
<span class="nf">.0x00001e8b</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">],</span> <span class="nb">rdi</span>  <span class="c1">; d1</span>
<span class="nf">.0x00001e8f</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">],</span> <span class="nb">rsi</span>  <span class="c1">; d2</span>
<span class="nf">.0x00001e93</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.crackme</span>  <span class="c1">; 0x2a7f ; "crackme"</span>
<span class="nf">.0x00001e9a</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyUnicode_FromString</span>
<span class="nf">.0x00001e9f</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ea3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">]</span>
<span class="nf">.0x00001ea7</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>                           
<span class="nf">.0x00001eaa</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyImport_Import</span>
<span class="nf">.0x00001eaf</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">],</span> <span class="nb">rax</span>             
<span class="nf">.0x00001eb3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span>
<span class="nf">.0x00001eb7</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001eba</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyModule_GetDict</span>
<span class="nf">.0x00001ebf</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ec3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ec7</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a87</span><span class="p">]</span> <span class="c1">; "add"</span>
<span class="nf">.0x00001ece</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001ed1</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001ed6</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_30h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001eda</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ede</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a8b</span><span class="p">]</span> <span class="c1">; "sub"</span>
<span class="nf">.0x00001ee5</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001ee8</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001eed</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_28h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ef1</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ef5</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a8f</span><span class="p">]</span> <span class="c1">; "mul"</span>
<span class="nf">.0x00001efc</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001eff</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f04</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_20h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f08</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f0c</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.div2</span>     <span class="c1">; 0x2a93 ; "div2"</span>
<span class="nf">.0x00001f13</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f16</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f1b</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_18h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f1f</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f23</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a98</span><span class="p">]</span> <span class="c1">; "mod"</span>
<span class="nf">.0x00001f2a</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f2d</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f32</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_10h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f36</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f3a</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a9c</span><span class="p">]</span> <span class="c1">; "sup"</span>
<span class="nf">.0x00001f41</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f44</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f49</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_8h</span><span class="p">],</span> <span class="nb">rax</span>
</pre>


<p>From above code we can extract variables with functions imported and assigned to them:</p>
<pre class="code literal-block"><span></span> <span class="n">local_30h</span> <span class="o">|</span> <span class="k">add</span>
 <span class="n">local_28h</span> <span class="o">|</span> <span class="n">sub</span>
 <span class="n">local_20h</span> <span class="o">|</span> <span class="n">mul</span>
 <span class="n">local_18h</span> <span class="o">|</span> <span class="n">div2</span>
 <span class="n">local_10h</span> <span class="o">|</span> <span class="k">mod</span>
 <span class="n">local_8h</span>  <span class="o">|</span> <span class="n">sup</span>
</pre>


<p>and also our longs:</p>
<pre class="code literal-block"><span></span> <span class="n">local_68h</span> <span class="o">|</span> <span class="n">d1</span>
 <span class="n">local_70h</span> <span class="o">|</span> <span class="n">d2</span>
</pre>


<p>We will need this to find out what calculations take place in <code>calc_flag__object___object</code>. 
I will replace <em>local_xxh</em> with known or chosen names.
This way the graph below should be easier to understand.</p>
<pre class="code literal-block"><span></span><span class="w">                                                        </span><span class="p">...</span><span class="w"></span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">sup</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                       </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w">                                 </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_FromLong</span><span class="p">;</span><span class="o">[</span><span class="n">ge</span><span class="o">]</span><span class="w">          </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                    </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">                                 </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_FromLong</span><span class="p">;</span><span class="o">[</span><span class="n">ge</span><span class="o">]</span><span class="w">          </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">last_factor</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">               </span><span class="o">|</span><span class="w">                               </span>
<span class="w">                                   </span><span class="err">`</span><span class="c1">--------------------------------------------'                               </span>
<span class="w">                                                               </span><span class="o">|</span><span class="w">                                                </span>
<span class="w">                                                               </span><span class="o">|</span><span class="w">                                                </span>
<span class="w">     </span><span class="p">.</span><span class="c1">---------------------------------------------------------.                                                </span>
<span class="w">     </span><span class="o">|</span><span class="w">                                                         </span><span class="o">|</span><span class="w">                                                </span>
<span class="w">     </span><span class="o">|</span><span class="w">                                                         </span><span class="o">|</span><span class="w">                                                </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="p">.</span><span class="c1">------------------------------------------------------------------.              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w">  </span><span class="mh">0x1f69</span><span class="w"> </span><span class="p">;</span><span class="o">[</span><span class="n">gj</span><span class="o">]</span><span class="w">                                                    </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">JMP</span><span class="w"> </span><span class="n">XREF</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mh">0x0000200d</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="p">.</span><span class="n">calc_flag__object___object</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">                                                       </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_FromLong</span><span class="p">;</span><span class="o">[</span><span class="n">ge</span><span class="o">]</span><span class="w">                                </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                     </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">d1</span><span class="o">]</span><span class="w">                                              </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">sup</span><span class="o">]</span><span class="w">                                             </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                                     </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                     </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">call__object___object___object</span><span class="p">;</span><span class="o">[</span><span class="n">gg</span><span class="o">]</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                     </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_AsLong</span><span class="p">;</span><span class="o">[</span><span class="n">gh</span><span class="o">]</span><span class="w">                                  </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                    </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">setne</span><span class="w"> </span><span class="n">al</span><span class="w">                                                         </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">                                                      </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x2012</span><span class="p">;</span><span class="o">[</span><span class="n">gi</span><span class="o">]</span><span class="w">                                                   </span><span class="o">|</span><span class="w">              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                        </span><span class="err">`</span><span class="c1">------------------------------------------------------------------'              </span>
<span class="w">     </span><span class="o">|</span><span class="w">                                                             </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">                                          </span>
<span class="w">     </span><span class="o">|</span><span class="w">                                                             </span><span class="o">|</span><span class="w"> </span><span class="s1">'------------.                             </span>
<span class="s1">     |                    .----------------------------------------'</span><span class="w">              </span><span class="o">|</span><span class="w">                             </span>
<span class="w">     </span><span class="o">|</span><span class="p">.</span><span class="c1">---------------.   |                                                       |                             </span>
<span class="w">     </span><span class="o">||</span><span class="w">               </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">                                                       </span><span class="o">|</span><span class="w">                             </span>
<span class="w">     </span><span class="o">||</span><span class="w">               </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">                                                       </span><span class="o">|</span><span class="w">                             </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="p">.</span><span class="c1">-----------------------------------------------.  .-----------------------------------------------.  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="mh">0x1f9b</span><span class="w"> </span><span class="p">;</span><span class="o">[</span><span class="n">gl</span><span class="o">]</span><span class="w">                                 </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="o">[</span><span class="n">0x2012</span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="o">[</span><span class="n">gi</span><span class="o">]</span><span class="w">                                </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">JMP</span><span class="w"> </span><span class="n">XREF</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mh">0x00001fe7</span><span class="w">               </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">JMP</span><span class="w"> </span><span class="n">XREF</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mh">0x00001f99</span><span class="w">               </span><span class="o">|</span><span class="w"> </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w">   </span><span class="p">(</span><span class="n">sym</span><span class="p">.</span><span class="n">calc_flag__object___object</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w">   </span><span class="p">(</span><span class="n">sym</span><span class="p">.</span><span class="n">calc_flag__object___object</span><span class="p">)</span><span class="w">     </span><span class="o">|</span><span class="w"></span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="w">                       </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">last_factor</span><span class="o">]</span><span class="w">                  </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">d1</span><span class="o">]</span><span class="w">                           </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">d2</span><span class="o">]</span><span class="w">                           </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">mod</span><span class="o">]</span><span class="w">                          </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">sub</span><span class="o">]</span><span class="w">                          </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                  </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                  </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                  </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                  </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">call__object___object___object</span><span class="p">;</span><span class="o">[</span><span class="n">gg</span><span class="o">]</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">call__object___object___object</span><span class="p">;</span><span class="o">[</span><span class="n">gg</span><span class="o">]</span><span class="w">  </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                  </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">leave</span><span class="w">                                         </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_AsLong</span><span class="p">;</span><span class="o">[</span><span class="n">gh</span><span class="o">]</span><span class="w">               </span><span class="o">|</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">ret</span><span class="w">                                           </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                 </span><span class="o">|</span><span class="w">  </span><span class="err">`</span><span class="c1">-----------------------------------------------'  </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">sete</span><span class="w"> </span><span class="n">al</span><span class="w">                                       </span><span class="o">|</span><span class="w">                                                                      </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">                                   </span><span class="o">|</span><span class="w">                                                                      </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="mh">0x1fe9</span><span class="p">;</span><span class="o">[</span><span class="n">gk</span><span class="o">]</span><span class="w">                                </span><span class="o">|</span><span class="w">                                                                      </span>
<span class="w">     </span><span class="o">||</span><span class="w">  </span><span class="err">`</span><span class="c1">-----------------------------------------------'                                                                      </span>
<span class="w">     </span><span class="o">||</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span><span class="w">                                                                                                    </span>
<span class="w">     </span><span class="o">||</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="s1">'------------------------------------.                                                               </span>
<span class="s1">     ||        .----------'</span><span class="w">                                      </span><span class="o">|</span><span class="w">                                                               </span>
<span class="w">     </span><span class="o">||</span><span class="w">        </span><span class="o">|</span><span class="w">                                                 </span><span class="o">|</span><span class="w">                                                               </span>
<span class="w">     </span><span class="o">||</span><span class="w">        </span><span class="o">|</span><span class="w">                                                 </span><span class="o">|</span><span class="w">                                                               </span>
<span class="w">     </span><span class="o">||</span><span class="p">.</span><span class="c1">-----------------------------------------------.   .------------------------------------------------------------------.  </span>
<span class="w">     </span><span class="o">|||</span><span class="w">  </span><span class="mh">0x1fc4</span><span class="w"> </span><span class="p">;</span><span class="o">[</span><span class="n">gm</span><span class="o">]</span><span class="w">                                 </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="mh">0x1fe9</span><span class="w"> </span><span class="p">;</span><span class="o">[</span><span class="n">gk</span><span class="o">]</span><span class="w">                                                    </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="w">                       </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">JMP</span><span class="w"> </span><span class="n">XREF</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="mh">0x00001fc2</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="p">.</span><span class="n">calc_flag__object___object</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">d1</span><span class="o">]</span><span class="w">                           </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">                                                       </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">div2</span><span class="o">]</span><span class="w">                         </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">imp</span><span class="p">.</span><span class="n">PyLong_FromLong</span><span class="p">;</span><span class="o">[</span><span class="n">ge</span><span class="o">]</span><span class="w">                                </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                  </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                     </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                  </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="w">                                          </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">call__object___object___object</span><span class="p">;</span><span class="o">[</span><span class="n">gg</span><span class="o">]</span><span class="w">  </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">add</span><span class="o">]</span><span class="w">                                             </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">d1</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                           </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                                     </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="w">                       </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                                     </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">last_factor</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                  </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">sym</span><span class="p">.</span><span class="n">call__object___object___object</span><span class="p">;</span><span class="o">[</span><span class="n">gg</span><span class="o">]</span><span class="w">                     </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">|||</span><span class="w"> </span><span class="n">jmp</span><span class="w"> </span><span class="mh">0x1f9b</span><span class="p">;</span><span class="o">[</span><span class="n">gl</span><span class="o">]</span><span class="w">                               </span><span class="o">|</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">mov</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="o">[</span><span class="n">factor</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                          </span><span class="o">|</span><span class="w">  </span>
<span class="w">     </span><span class="o">||</span><span class="err">`</span><span class="c1">-----------------------------------------------'   | jmp 0x1f69;[gj]                                                  |  </span>
<span class="w">     </span><span class="o">||</span><span class="w">    </span><span class="o">|</span><span class="w">                                               </span><span class="err">`</span><span class="c1">------------------------------------------------------------------'  </span>
<span class="w">     </span><span class="o">||</span><span class="w">    </span><span class="o">|</span><span class="w">                                                   </span><span class="o">|</span><span class="w">                                                                 </span>
<span class="w">     </span><span class="o">|</span><span class="err">`</span><span class="c1">----'                                                   |                                                    </span>
<span class="w">     </span><span class="err">`</span><span class="c1">---------------------------------------------------------' </span>
</pre>


<p>Calling python functions convention is to put the address of an imported function to <code>rdi</code> register and
the address of python object with the first argument to <code>rsi</code>, <code>rdx</code> will have the second argument address. Then there is a call to
 <code>sym.call__object___object___object</code>, the result will be also python object which address will be in <code>rax</code> register.</p>
<p>The algorithm shown above could be described like this:</p>
<ol>
<li>Set <code>factor = 2</code> and <code>last_factor = 1</code>.</li>
<li>Next, we check if <code>d1</code> is greater than <code>1</code>. If not <code>return d2 - last_factor</code>.</li>
<li>Test if <code>factor</code> divides <code>d1</code> with no rest. If <em>True</em> then go to <em>step 4</em>  else <em>step 5</em>.</li>
<li>
<code>d1 = d1 / factor</code> and save the value of <code>factor</code> in <code>last_factor</code> and go to <em>step 3</em>. </li>
<li>
<code>factor += 1</code> and go to <em>step 2</em>.</li>
</ol>
<p>In other words, when condition <code>d1 &gt; 1</code> will not be fulfilled <code>last_factor</code> will hold the greatest
 prime factor of <code>d1</code>. And this value will be subtracted from <code>d2</code> and the result will be returned
 from the function. As you might already suspect running this program will give us nothing.
 So we better write our faster version of it.</p>
<p>To get the greatest prime factor of <code>d1</code> I will use <strong><a href="https://pypi.org/project/primefac/">primefac</a></strong>  python library.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">primefac</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">arg1</span> <span class="o">=</span> <span class="mi">25052671110843108</span>
<span class="n">arg2</span> <span class="o">=</span> <span class="mi">16420105858350620421142892712</span>

<span class="n">fac</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">primefac</span><span class="o">.</span><span class="n">primefac</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="p">)</span>
<span class="n">bigestPrime</span> <span class="o">=</span> <span class="n">fac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">flag</span> <span class="o">=</span> <span class="n">arg2</span> <span class="o">-</span> <span class="n">bigestPrime</span>
<span class="n">flag_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">flag_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre>


<p>And here we have the content of the flag.</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/ctf/" rel="tag">ctf</a></li>
            <li><a class="tag p-category" href="../../categories/icon/" rel="tag">icon</a></li>
            <li><a class="tag p-category" href="../../categories/re/" rel="tag">re</a></li>
            <li><a class="tag p-category" href="../../categories/reverse/" rel="tag">reverse</a></li>
            <li><a class="tag p-category" href="../../categories/writeups/" rel="tag">writeups</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../cpprest-listener/" rel="prev" title="0x04 cpprest listener">Previous post</a>
            </li>
            <li class="next">
                <a href="../how-my-shell-mess-with-me/" rel="next" title="How my shell mess with me">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="death-of-rats-github-io",
            disqus_url="https://death-of-rats.github.io/posts/icon_2018_ctf_third_challenge/",
        disqus_title="Icon 2018 CTF third challenge",
        disqus_identifier="cache/posts/icon_2018_ctf_third_challenge.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="death-of-rats-github-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2019         death-of-rats - powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br><img src="https://travis-ci.org/death-of-rats/death-of-rats.github.io.svg?branch=source"></footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('a.reference:not(.islink)', {
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    baguetteBox.run('img:not(.islink)', {
        captions: function(element) {
            return element.alt;
    }});
    </script>
</body>
</html>
