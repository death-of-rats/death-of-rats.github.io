<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="The end of my mind...">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Death Of Rats</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://death-of-rats.github.io/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/icon_2018_ctf_third_challenge/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="https://death-of-rats.github.io/">

            <span id="blog-title">Death Of Rats</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav"></ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100">
<li class="nav-item">
<a href="archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
    
        

    
        
    <div class="postindex">
            <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/icon_2018_ctf_third_challenge/" class="u-url">Icon 2018 CTF third challenge</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/icon_2018_ctf_third_challenge/" rel="bookmark"><time class="published dt-published" datetime="2018-09-14T00:00:00+02:00" title="2018-09-14 00:00">2018-09-14 00:00</time></a></p>
                        <p class="commentline">
        
    <a href="posts/icon_2018_ctf_third_challenge/#disqus_thread" data-disqus-identifier="cache/posts/icon_2018_ctf_third_challenge.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>The third challenge is a reverse engineering problem. The zipped package contains 3 files:</p>
<pre class="code literal-block"><span></span>crackme_baby
crackme.py
run.sh
</pre>


<p>Python file contains definitions of simple math operations (add, sub, mul, div2, mod, inf). Let us
 disassemble crackme_baby file.</p>
<p>Main function shows us that 2 long variables are in play, <code>d1 = 25052671110843108</code> 
 and <code>d2 = 16420105858350620421142892712</code>. They are passed to <code>calc_flag__object___object</code> to calculate 
value for the flag. This value is hashed with sha256 and print in format flag{<em>hashed_value</em>}.</p>
<pre class="code literal-block"><span></span><span class="nf">.0x000021c3</span>      <span class="nv">push</span> <span class="nb">rbp</span>                    <span class="c1">; main(int argc, char** argv)</span>
<span class="nf">.0x000021c4</span>      <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
<span class="nf">.0x000021c7</span>      <span class="nv">push</span> <span class="nb">rbx</span>
<span class="nf">.0x000021c8</span>      <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x88</span>
<span class="nf">.0x000021cf</span>      <span class="nv">mov</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">local_84h</span><span class="p">],</span> <span class="nb">edi</span>  <span class="c1">; argc</span>
<span class="nf">.0x000021d5</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_90h</span><span class="p">],</span> <span class="nb">rsi</span>  <span class="c1">; argv</span>
<span class="nf">.0x000021dc</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="nb">fs</span><span class="p">:[</span><span class="mh">0x28</span><span class="p">]</span>    <span class="c1">; [0x28:8]=0x6108 ; '('</span>
<span class="nf">.0x000021e5</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_18h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x000021e9</span>      <span class="nv">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
<span class="nf">.0x000021eb</span>      <span class="nv">call</span> <span class="nv">sym.imp.Py_Initialize</span>
<span class="nf">.0x000021f0</span>      <span class="nv">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xa</span>
<span class="nf">.0x000021f5</span>      <span class="nv">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="mi">0</span>
<span class="nf">.0x000021fa</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.25052671110843108</span> <span class="c1">; 0x2aa0 ; "25052671110843108"</span>
<span class="nf">.0x00002201</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_FromString</span>       <span class="c1">; create python long object</span>
<span class="nf">.0x00002206</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_78h</span><span class="p">],</span> <span class="nb">rax</span>           <span class="c1">; here we have d1</span>
<span class="nf">.0x0000220a</span>      <span class="nv">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="mh">0xa</span>
<span class="nf">.0x0000220f</span>      <span class="nv">mov</span> <span class="nb">esi</span><span class="p">,</span> <span class="mi">0</span>
<span class="nf">.0x00002214</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.16420105858350620421142892712</span> <span class="c1">; 0x2ab2 ; "16420105858350620421142892712"</span>
<span class="nf">.0x0000221b</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_FromString</span>
<span class="nf">.0x00002220</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">],</span> <span class="nb">rax</span>           <span class="c1">; here we have d2</span>
<span class="nf">.0x00002224</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">]</span>
<span class="nf">.0x00002228</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_78h</span><span class="p">]</span>
<span class="nf">.0x0000222c</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x0000222f</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002232</span>      <span class="nv">call</span> <span class="nv">sym.calc_flag__object___object</span> <span class="c1">; compute the value for the flag</span>
<span class="nf">.0x00002237</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x0000223b</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.flag</span><span class="p">:</span><span class="nv">_flag</span> <span class="c1">; 0x2ad0 ; "flag: flag{"  </span>
<span class="nf">.0x00002242</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">obj._ZSt4cout__GLIBCXX_3.4</span> <span class="c1">; 0x204020</span>
<span class="nf">.0x00002249</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____charconst</span>
<span class="nf">.0x0000224e</span>      <span class="nv">mov</span> <span class="nb">rbx</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002251</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">]</span> <span class="c1">; get computed value</span>
<span class="nf">.0x00002255</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002258</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyLong_AsLong</span> <span class="c1">; convert Python object to long</span>
<span class="nf">.0x0000225d</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002260</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_60h</span><span class="p">]</span>
<span class="nf">.0x00002264</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x00002267</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000226a</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">to_string_long</span> <span class="c1">; long -&gt; string</span>
<span class="nf">.0x0000226f</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span> <span class="c1">; buffer for sha256 result</span>
<span class="nf">.0x00002273</span>      <span class="nv">lea</span> <span class="nb">rdx</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_60h</span><span class="p">]</span> <span class="c1">; string with the computed long value</span>
<span class="nf">.0x00002277</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>
<span class="nf">.0x0000227a</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000227d</span>      <span class="nv">call</span> <span class="nv">sym.sha256_std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">basic_string_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char</span>
<span class="nf">.0x00002282</span>      <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span> <span class="c1">; we will print sha256 hash</span>
<span class="nf">.0x00002286</span>      <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00002289</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rbx</span>
<span class="nf">.0x0000228c</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____std</span><span class="p">::</span><span class="nv">__cxx11</span><span class="p">::</span><span class="nv">basic_string_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char__std</span><span class="p">::</span><span class="nb">al</span><span class="nv">locator_char__const</span>
<span class="nf">.0x00002291</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002adc</span><span class="p">]</span> <span class="c1">; "}" </span>
<span class="nf">.0x00002298</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x0000229b</span>      <span class="nv">call</span> <span class="nv">sym.std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">operator___std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char___std</span><span class="p">::</span><span class="nv">basic_ostream_char_std</span><span class="p">::</span><span class="nb">ch</span><span class="nv">ar_traits_char____charconst</span>
<span class="nf">.0x000022a0</span>      <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="nb">rax</span>
                  <span class="nf">...</span>
</pre>


<p>So it's time to look closer at function <code>calc_flag__object___object</code>. First instructions just load <code>crackme.py</code> 
and import math functions: </p>
<pre class="code literal-block"><span></span><span class="nf">.0x00001e83</span>      <span class="nv">push</span> <span class="nb">rbp</span>                               
<span class="nf">.0x00001e84</span>      <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>                
<span class="nf">.0x00001e87</span>      <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x70</span>               <span class="c1">; 'p'</span>
<span class="nf">.0x00001e8b</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_68h</span><span class="p">],</span> <span class="nb">rdi</span>  <span class="c1">; d1</span>
<span class="nf">.0x00001e8f</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_70h</span><span class="p">],</span> <span class="nb">rsi</span>  <span class="c1">; d2</span>
<span class="nf">.0x00001e93</span>      <span class="nv">lea</span> <span class="nb">rdi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.crackme</span>  <span class="c1">; 0x2a7f ; "crackme"</span>
<span class="nf">.0x00001e9a</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyUnicode_FromString</span>
<span class="nf">.0x00001e9f</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ea3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">]</span>
<span class="nf">.0x00001ea7</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>                           
<span class="nf">.0x00001eaa</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyImport_Import</span>
<span class="nf">.0x00001eaf</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">],</span> <span class="nb">rax</span>             
<span class="nf">.0x00001eb3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span>
<span class="nf">.0x00001eb7</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001eba</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyModule_GetDict</span>
<span class="nf">.0x00001ebf</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ec3</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ec7</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a87</span><span class="p">]</span> <span class="c1">; "add"</span>
<span class="nf">.0x00001ece</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001ed1</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001ed6</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_30h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001eda</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ede</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a8b</span><span class="p">]</span> <span class="c1">; "sub"</span>
<span class="nf">.0x00001ee5</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001ee8</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001eed</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_28h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001ef1</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001ef5</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a8f</span><span class="p">]</span> <span class="c1">; "mul"</span>
<span class="nf">.0x00001efc</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001eff</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f04</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_20h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f08</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f0c</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="nv">str.div2</span>     <span class="c1">; 0x2a93 ; "div2"</span>
<span class="nf">.0x00001f13</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f16</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f1b</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_18h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f1f</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f23</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a98</span><span class="p">]</span> <span class="c1">; "mod"</span>
<span class="nf">.0x00001f2a</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f2d</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f32</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_10h</span><span class="p">],</span> <span class="nb">rax</span>
<span class="nf">.0x00001f36</span>      <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_38h</span><span class="p">]</span>
<span class="nf">.0x00001f3a</span>      <span class="nv">lea</span> <span class="nb">rsi</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="mh">0x00002a9c</span><span class="p">]</span> <span class="c1">; "sup"</span>
<span class="nf">.0x00001f41</span>      <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="nf">.0x00001f44</span>      <span class="nv">call</span> <span class="nv">sym.imp.PyDict_GetItemString</span>
<span class="nf">.0x00001f49</span>      <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_8h</span><span class="p">],</span> <span class="nb">rax</span>
</pre>


<p>From above code we can extract variables with functions imported and assigned to them:</p>
<pre class="code literal-block"><span></span> local_30h | add
 local_28h | sub
 local_20h | mul
 local_18h | div2
 local_10h | mod
 local_8h  | sup
</pre>


<p>and also our longs:</p>
<pre class="code literal-block"><span></span> local_68h | d1
 local_70h | d2
</pre>


<p>We will need this to find out what calculations take place in <code>calc_flag__object___object</code>. 
I will replace <em>local_xxh</em> with known or chosen names.
This way the graph below should be easier to understand.</p>
<pre class="code literal-block"><span></span>                                                        ...
                                   | mov qword [sup], rax                       |                               
                                   | mov edi, 2                                 |                               
                                   | call sym.imp.PyLong_FromLong;[ge]          |                               
                                   | mov qword [factor], rax                    |                               
                                   | mov edi, 1                                 |                               
                                   | call sym.imp.PyLong_FromLong;[ge]          |                               
                                   | mov qword [last_factor], rax               |                               
                                   `--------------------------------------------'                               
                                                               |                                                
                                                               |                                                
     .---------------------------------------------------------.                                                
     |                                                         |                                                
     |                                                         |                                                
     |                        .------------------------------------------------------------------.              
     |                        |  0x1f69 ;[gj]                                                    |              
     |                        |      ; JMP XREF from 0x0000200d (sym.calc_flag__object___object) |              
     |                        | mov edi, 1                                                       |              
     |                        | call sym.imp.PyLong_FromLong;[ge]                                |              
     |                        | mov rdx, rax                                                     |              
     |                        | mov rcx, qword [d1]                                              |              
     |                        | mov rax, qword [sup]                                             |              
     |                        | mov rsi, rcx                                                     |              
     |                        | mov rdi, rax                                                     |              
     |                        | call sym.call__object___object___object;[gg]                     | 
     |                        | mov rdi, rax                                                     |              
     |                        | call sym.imp.PyLong_AsLong;[gh]                                  |              
     |                        | test rax, rax                                                    |              
     |                        | setne al                                                         |              
     |                        | test al, al                                                      |              
     |                        | je 0x2012;[gi]                                                   |              
     |                        `------------------------------------------------------------------'              
     |                                                             | |                                          
     |                                                             | '------------.                             
     |                    .----------------------------------------'              |                             
     |.---------------.   |                                                       |                             
     ||               |   |                                                       |                             
     ||               |   |                                                       |                             
     ||  .-----------------------------------------------.  .-----------------------------------------------.  
     ||  |  0x1f9b ;[gl]                                 |  | [0x2012] ;[gi]                                |  
     ||  |      ; JMP XREF from 0x00001fe7               |  |      ; JMP XREF from 0x00001f99               | 
     ||  |      ;   (sym.calc_flag__object___object)     |  |      ;   (sym.calc_flag__object___object)     |
     ||  | mov rdx, qword [factor]                       |  | mov rdx, qword [last_factor]                  |  
     ||  | mov rcx, qword [d1]                           |  | mov rcx, qword [d2]                           |  
     ||  | mov rax, qword [mod]                          |  | mov rax, qword [sub]                          |  
     ||  | mov rsi, rcx                                  |  | mov rsi, rcx                                  |  
     ||  | mov rdi, rax                                  |  | mov rdi, rax                                  |  
     ||  | call sym.call__object___object___object;[gg]  |  | call sym.call__object___object___object;[gg]  |  
     ||  | mov rdi, rax                                  |  | leave                                         |  
     ||  | call sym.imp.PyLong_AsLong;[gh]               |  | ret                                           |  
     ||  | test rax, rax                                 |  `-----------------------------------------------'  
     ||  | sete al                                       |                                                                      
     ||  | test al, al                                   |                                                                      
     ||  | je 0x1fe9;[gk]                                |                                                                      
     ||  `-----------------------------------------------'                                                                      
     ||                   | |                                                                                                    
     ||                   | '------------------------------------.                                                               
     ||        .----------'                                      |                                                               
     ||        |                                                 |                                                               
     ||        |                                                 |                                                               
     ||.-----------------------------------------------.   .------------------------------------------------------------------.  
     |||  0x1fc4 ;[gm]                                 |   |  0x1fe9 ;[gk]                                                    |  
     ||| mov rdx, qword [factor]                       |   |      ; JMP XREF from 0x00001fc2 (sym.calc_flag__object___object) |  
     ||| mov rcx, qword [d1]                           |   | mov edi, 1                                                       |  
     ||| mov rax, qword [div2]                         |   | call sym.imp.PyLong_FromLong;[ge]                                |  
     ||| mov rsi, rcx                                  |   | mov rdx, rax                                                     |  
     ||| mov rdi, rax                                  |   | mov rcx, qword [factor]                                          |  
     ||| call sym.call__object___object___object;[gg]  |   | mov rax, qword [add]                                             |  
     ||| mov qword [d1], rax                           |   | mov rsi, rcx                                                     |  
     ||| mov rax, qword [factor]                       |   | mov rdi, rax                                                     |  
     ||| mov qword [last_factor], rax                  |   | call sym.call__object___object___object;[gg]                     |  
     ||| jmp 0x1f9b;[gl]                               |   | mov qword [factor], rax                                          |  
     ||`-----------------------------------------------'   | jmp 0x1f69;[gj]                                                  |  
     ||    |                                               `------------------------------------------------------------------'  
     ||    |                                                   |                                                                 
     |`----'                                                   |                                                    
     `---------------------------------------------------------' 
</pre>


<p>Calling python functions convention is to put the address of an imported function to <code>rdi</code> register and
the address of python object with the first argument to <code>rsi</code>, <code>rdx</code> will have the second argument address. Then there is a call to
 <code>sym.call__object___object___object</code>, the result will be also python object which address will be in <code>rax</code> register.</p>
<p>The algorithm shown above could be described like this:</p>
<ol>
<li>Set <code>factor = 2</code> and <code>last_factor = 1</code>.</li>
<li>Next, we check if <code>d1</code> is greater than <code>1</code>. If not <code>return d2 - last_factor</code>.</li>
<li>Test if <code>factor</code> divides <code>d1</code> with no rest. If <em>True</em> then go to <em>step 4</em>  else <em>step 5</em>.</li>
<li>
<code>d1 = d1 / factor</code> and save the value of <code>factor</code> in <code>last_factor</code> and go to <em>step 3</em>. </li>
<li>
<code>factor += 1</code> and go to <em>step 2</em>.</li>
</ol>
<p>In other words, when condition <code>d1 &gt; 1</code> will not be fulfilled <code>last_factor</code> will hold the greatest
 prime factor of <code>d1</code>. And this value will be subtracted from <code>d2</code> and the result will be returned
 from the function. As you might already suspect running this program will give us nothing.
 So we better write our faster version of it.</p>
<p>To get the greatest prime factor of <code>d1</code> I will use <strong><a href="https://pypi.org/project/primefac/">primefac</a></strong>  python library.</p>
<pre class="code literal-block"><span></span><span class="kn">import</span> <span class="nn">primefac</span>
<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">arg1</span> <span class="o">=</span> <span class="mi">25052671110843108</span>
<span class="n">arg2</span> <span class="o">=</span> <span class="mi">16420105858350620421142892712</span>

<span class="n">fac</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">primefac</span><span class="o">.</span><span class="n">primefac</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="p">)</span>
<span class="n">bigestPrime</span> <span class="o">=</span> <span class="n">fac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">flag</span> <span class="o">=</span> <span class="n">arg2</span> <span class="o">-</span> <span class="n">bigestPrime</span>
<span class="n">flag_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">flag_str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre>


<p>And here we have the content of the flag.</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/cpprest-listener/" class="u-url">0x04 cpprest listener</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/cpprest-listener/" rel="bookmark"><time class="published dt-published" datetime="2018-06-01T00:00:00+02:00" title="2018-06-01 00:00">2018-06-01 00:00</time></a></p>
                        <p class="commentline">
        
    <a href="posts/cpprest-listener/#disqus_thread" data-disqus-identifier="cache/posts/cpprest-listener.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>I want to try to build simple REST server demo with <em>cpprestsdk</em>. It is still experimental part of the library.</p>
<p>Let's start the program. I want to listen on <em>localhost</em> on port 9000 with relative path <em>/demo</em>. For now, 
the program will handle only <em>GET</em> and <em>POST</em>. When the listener starts, we get a notification. 
<em>cpprestsdk</em> uses <code>pplx::task&lt;T&gt;</code> for composing asynchronous operations (<code>...then().then().wait()</code>). The main
loop is very simple, we just <code>while</code> infinitely.</p>
<pre class="code literal-block"><span></span><span class="cp">#include</span> <span class="cpf">&lt;cpprest/http_listener.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cpprest/json.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">web</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">web</span><span class="o">::</span><span class="n">http</span><span class="o">::</span><span class="n">experimental</span><span class="o">::</span><span class="n">listener</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">handle_get</span><span class="p">(</span><span class="n">http_request</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">"[HTTP] GET</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">json</span><span class="o">::</span><span class="n">value</span>  <span class="n">answer</span><span class="p">;</span>
    <span class="n">answer</span><span class="p">[</span><span class="n">U</span><span class="p">(</span><span class="s">"version"</span><span class="p">)]</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">value</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"0.0.1"</span><span class="p">));</span>
    <span class="n">answer</span><span class="p">[</span><span class="n">U</span><span class="p">(</span><span class="s">"name"</span><span class="p">)]</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">value</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"death of rats"</span><span class="p">));</span>
    <span class="n">request</span><span class="p">.</span><span class="n">reply</span><span class="p">(</span><span class="n">status_codes</span><span class="o">::</span><span class="n">OK</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">handle_post</span><span class="p">(</span><span class="n">http_request</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">"[HTTP] POST</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">request</span>
        <span class="p">.</span><span class="n">extract_json</span><span class="p">()</span>
        <span class="p">.</span><span class="n">then</span><span class="p">([</span><span class="o">&amp;</span><span class="n">request</span><span class="p">](</span><span class="n">json</span><span class="o">::</span><span class="n">value</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="p">.</span><span class="n">is_null</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">request</span><span class="p">.</span><span class="n">reply</span><span class="p">(</span><span class="n">status_codes</span><span class="o">::</span><span class="n">BadRequest</span><span class="p">,</span> <span class="n">U</span><span class="p">(</span><span class="s">"No object in post data."</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">request</span><span class="p">.</span><span class="n">reply</span><span class="p">(</span><span class="n">status_codes</span><span class="o">::</span><span class="n">OK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}).</span><span class="n">wait</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">http_listener</span> <span class="n">listener</span><span class="p">(</span><span class="n">uri</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="s">"http://localhost:9000/demo"</span><span class="p">)));</span>

    <span class="n">listener</span><span class="p">.</span><span class="n">support</span><span class="p">(</span><span class="n">methods</span><span class="o">::</span><span class="n">GET</span><span class="p">,</span> <span class="n">handle_get</span><span class="p">);</span>
    <span class="n">listener</span><span class="p">.</span><span class="n">support</span><span class="p">(</span><span class="n">methods</span><span class="o">::</span><span class="n">POST</span><span class="p">,</span> <span class="n">handle_post</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="n">listener</span>
            <span class="p">.</span><span class="n">open</span><span class="p">()</span>
            <span class="p">.</span><span class="n">then</span><span class="p">([</span><span class="o">&amp;</span><span class="n">listener</span><span class="p">](){</span>
                <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="sa">L</span><span class="s">"starting to listen</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>        
            <span class="p">})</span>
            <span class="p">.</span><span class="n">wait</span><span class="p">();</span>

        <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">exception</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">wcout</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre>


<p>To build this code I use CMake with configuration from last post 
[<a href="posts/building-cpprest-sample/">0x03 building cpprest sample</a>]. </p>
<pre class="code literal-block"><span></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.7</span><span class="p">)</span>
<span class="nb">project</span><span class="p">(</span><span class="s">simargl</span> <span class="s">C</span> <span class="s">CXX</span><span class="p">)</span>
<span class="nb">set</span> <span class="p">(</span><span class="s">simargl_VERSION_MAJOR</span> <span class="s">0</span><span class="p">)</span>
<span class="nb">set</span> <span class="p">(</span><span class="s">simargl_VERSION_MINOR</span> <span class="s">1</span><span class="p">)</span>
<span class="nb">set</span> <span class="p">(</span><span class="s">CMAKE_CXX_STANDARD</span> <span class="s">14</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span> <span class="s">CMAKE_EXPORT_COMPILE_COMMANDS</span> <span class="s">ON</span> <span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">cpprestsdk</span> <span class="s">REQUIRED</span> <span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">Boost</span> <span class="s">REQUIRED</span> <span class="s">COMPONENTS</span> <span class="s">system</span><span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span><span class="s">OpenSSL</span> <span class="s">REQUIRED</span><span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span><span class="s">simargl</span> <span class="s">src/main.cpp</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">simargl</span> <span class="s">PRIVATE</span>
    <span class="s">cpprestsdk::cpprest</span>
    <span class="o">${</span><span class="nv">Boost_LIBRARIES</span><span class="o">}</span> 
    <span class="o">${</span><span class="nv">OPENSSL_LIBRARIES</span><span class="o">}</span>
    <span class="p">)</span>

<span class="c">#message("OpenSSL libs:" ${OPENSSL_LIBRARIES})</span>
<span class="c">#message("Boost libs :" ${Boost_LIBRARIES})</span>
<span class="c">#message("CppRest libs :" ${cpprestsdk_LIBRARIES})</span>
</pre>


<p>The build goes flawlessly. To test the cpprest listener run the program and try a few curl commands:</p>
<pre class="code literal-block"><span></span>$ curl http://localhost:9000/demo
</pre>


<pre class="code literal-block"><span></span>{"name":"death of rats","version":"0.0.1"}
</pre>


<pre class="code literal-block"><span></span>$ curl --request POST --data <span class="s1">'{"label":"value"}'</span> -H <span class="s2">"Content-Type: application/json"</span>  http://localhost:9000/demo
</pre>


<pre class="code literal-block"><span></span>{"label":"value"}
</pre>


<p>What have I learned? If one is looking for examples, one should look up tests...</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/building-cpprest-sample/" class="u-url">0x03 building cpprest sample</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/building-cpprest-sample/" rel="bookmark"><time class="published dt-published" datetime="2018-05-27T22:00:00Z" title="2018-05-27 22:00">2018-05-27 22:00</time></a></p>
                        <p class="commentline">
        
    <a href="posts/building-cpprest-sample/#disqus_thread" data-disqus-identifier="cache/posts/building-cpprest-sample.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>One can install the <a href="https://github.com/Microsoft/cpprestsdk">C++ REST SDK</a> running 
<code>sudo apt install libcpprest-dev</code>. Unfortunately after that my CMake couldn't find it. 
I have some other troubles with compiling a project with cpprest. So I change my mind and 
I built the library from the source 
(<a href="https://github.com/Microsoft/cpprestsdk/wiki/How-to-build-for-Linux">instructions</a>).</p>
<p>To try the new toy I choose this <a href="https://github.com/Microsoft/cpprestsdk/blob/master/Release/samples/BingRequest/bingrequest.cpp">sample</a>.
<!-- TEASER_END -->
For the test, I will rename the source file to <code>main.cpp</code>. Let us create CMakeLists.txt. The readme of 
the project gives us the example:</p>
<pre class="code literal-block"><span></span>cmake_minimum_required<span class="o">(</span>VERSION <span class="m">3</span>.7<span class="o">)</span>
project<span class="o">(</span>main<span class="o">)</span>

find_package<span class="o">(</span>cpprestsdk REQUIRED<span class="o">)</span>

add_executable<span class="o">(</span>main main.cpp<span class="o">)</span>
target_link_libraries<span class="o">(</span>main PRIVATE cpprestsdk::cpprest<span class="o">)</span>
</pre>


<p>I know this is the time of trial:</p>
<pre class="code literal-block"><span></span>$ mkdir build
$ <span class="nb">cd</span> build
$ cmake ..
</pre>


<pre class="code literal-block"><span></span> -- The C compiler identification is GNU 7.3.0
 -- The CXX compiler identification is GNU 7.3.0
 -- Check for working C compiler: /usr/bin/cc
 -- Check for working C compiler: /usr/bin/cc -- works
 -- Detecting C compiler ABI info
 -- Detecting C compiler ABI info - done
 -- Detecting C compile features
 -- Detecting C compile features - done
 -- Check for working CXX compiler: /usr/bin/c++
 -- Check for working CXX compiler: /usr/bin/c++ -- works
 -- Detecting CXX compiler ABI info
 -- Detecting CXX compiler ABI info - done
 -- Detecting CXX compile features
 -- Detecting CXX compile features - done
 -- Found ZLIB: /usr/lib/x86_64-linux-gnu/libz.so (found version "1.2.11") 
 -- Found OpenSSL: /usr/lib/x86_64-linux-gnu/libcrypto.so (found version "1.1.0g") 
 -- Configuring done
 -- Generating done
 -- Build files have been written to: ~/Projects/cpprest01/build
</pre>


<pre class="code literal-block"><span></span>$ make
</pre>


<pre class="code literal-block"><span></span> Scanning dependencies of target main
 [ 50%] Building CXX object CMakeFiles/main.dir/main.cpp.o
 [100%] Linking CXX executable main
 /usr/bin/x86_64-linux-gnu-ld: CMakeFiles/main.dir/main.cpp.o: undefined reference to symbol '_ZN5boost6system15system_categoryEv'
 //usr/lib/x86_64-linux-gnu/libboost_system.so.1.65.1: error adding symbols: DSO missing from command line
 collect2: error: ld returned 1 exit status
 CMakeFiles/main.dir/build.make:97: recipe for target 'main' failed
 make[2]: \*\*\* [main] Error 1
 CMakeFiles/Makefile2:67: recipe for target 'CMakeFiles/main.dir/all' failed
 make[1]: \*\*\* [CMakeFiles/main.dir/all] Error 2
 Makefile:83: recipe for target 'all' failed
 make: \*\*\* [all] Error 2
</pre>


<h3>cmake for Microsoft/cpprestsdk</h3>
<p>Ok, so it doesn't work... surprise, surprise.</p>
<p>Time to go back to instructions for building <strong>cpprest</strong> on Linux. There is <code>g++</code> instruction 
at the end of the page. It builds the project with our library:</p>
<pre class="code literal-block"><span></span><span class="n">g</span><span class="o">++</span> <span class="o">-</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">11</span> <span class="n">my_file</span><span class="p">.</span><span class="n">cpp</span> <span class="o">-</span><span class="n">o</span> <span class="n">my_file</span> <span class="o">-</span><span class="n">lboost_system</span> <span class="o">-</span><span class="n">lcrypto</span> <span class="o">-</span><span class="n">lssl</span> <span class="o">-</span><span class="n">lcpprest</span> <span class="p">.</span><span class="o">/</span><span class="n">my_file</span>
</pre>


<p>And it works... So change our <code>CMakeLists.txt</code>. We want to use <em>Boost</em> and <em>OpenSSL</em> (this 
library contains both <em>SSL</em> and <em>crypto</em>). Add this two libraries to cmake configuration:</p>
<pre class="code literal-block"><span></span>...
find_package<span class="o">(</span>Boost REQUIRED COMPONENTS system<span class="o">)</span>
find_package<span class="o">(</span>OpenSSL REQUIRED<span class="o">)</span>
                                             <span class="c1"># show lib paths</span>
message<span class="o">(</span><span class="s2">"OpenSSL: "</span> <span class="si">${</span><span class="nv">OPENSSL_LIBRARIES</span><span class="si">}</span><span class="o">)</span>    <span class="c1"># libs to be linked by OpenSSL</span>
message<span class="o">(</span><span class="s2">"Boost: "</span> <span class="si">${</span><span class="nv">Boost_LIBRARIES</span><span class="si">}</span><span class="o">)</span>        <span class="c1"># linked components of Boosta</span>

add_executable<span class="o">(</span>main main.cpp<span class="o">)</span>
target_link_libraries<span class="o">(</span>main PRIVATE
    cpprestsdk::cpprest
    <span class="si">${</span><span class="nv">Boost_LIBRARIES</span><span class="si">}</span>
    <span class="si">${</span><span class="nv">OPENSSL_LIBRARIES</span><span class="si">}</span><span class="o">)</span>
</pre>


<pre class="code literal-block"><span></span>$ cmake ..
</pre>


<pre class="code literal-block"><span></span> -- The C compiler identification is GNU 7.3.0
 -- The CXX compiler identification is GNU 7.3.0
 -- Check for working C compiler: /usr/bin/cc
 -- Check for working C compiler: /usr/bin/cc -- works
 -- Detecting C compiler ABI info
 -- Detecting C compiler ABI info - done
 -- Detecting C compile features
 -- Detecting C compile features - done
 -- Check for working CXX compiler: /usr/bin/c++
 -- Check for working CXX compiler: /usr/bin/c++ -- works
 -- Detecting CXX compiler ABI info
 -- Detecting CXX compiler ABI info - done
 -- Detecting CXX compile features
 -- Detecting CXX compile features - done
 -- Found ZLIB: /usr/lib/x86_64-linux-gnu/libz.so (found version "1.2.11") 
 -- Found OpenSSL: /usr/lib/x86_64-linux-gnu/libcrypto.so (found version "1.1.0g") 
 -- Boost version: 1.65.1
 -- Found the following Boost libraries:
 --   system
 OpenSSL: /usr/lib/x86_64-linux-gnu/libssl.so/usr/lib/x86_64-linux-gnu/libcrypto.so
 Boost: /usr/lib/x86_64-linux-gnu/libboost_system.so
 -- Configuring done
 -- Generating done
 -- Build files have been written to: ~/Projects/cpprest01/build
</pre>


<pre class="code literal-block"><span></span>$ make
</pre>


<pre class="code literal-block"><span></span> Scanning dependencies of target main
 [ 50%] Building CXX object CMakeFiles/main.dir/main.cpp.o
 [100%] Linking CXX executable main
 [100%] Built target main
</pre>


<p>Done. One day in a hundred lines...</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/travis-nikola/" class="u-url">0x02 travis + nikola</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/travis-nikola/" rel="bookmark"><time class="published dt-published" datetime="2018-05-25T00:00:00Z" title="2018-05-25 00:00">2018-05-25 00:00</time></a></p>
                        <p class="commentline">
        
    <a href="posts/travis-nikola/#disqus_thread" data-disqus-identifier="cache/posts/travis-nikola.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>One has running Nikola. One stores all ones work on GitHub and hosts it on the GitHub Pages. Nice. But 
do I really need to push my changes to the repo, and when I'm ready, build static pages and push them 
to the <code>master</code>. And what if I'm not at my computer, what if I must change some typo. It would be 
nice if something could do this build and deploy the stuff for me.</p>
<p>That is why I invite...</p>
<!-- TEASER_END -->

<h3>Travis CI</h3>
<p>What one needs to have to proceed? Travis account connected to the GitHub account. Choose repository 
with your site and change some settings. I checked <em>Build only if .travis.yml is present</em>, <em>Build 
pushed branches</em> and <em>Build pushed pull requests</em>. </p>
<p>As the 'checkbox' says Travis will build only if <em>.travis.yml</em> is present. So add it to the repo! 
Travis should do 2 things: build static files and deploy them to master. The first part should look like:</p>
<pre class="code literal-block"><span></span><span class="n">language</span><span class="o">:</span> <span class="n">python</span>
<span class="n">cache</span><span class="o">:</span> <span class="n">apt</span>
<span class="n">sudo</span><span class="o">:</span> <span class="kc">false</span>
<span class="n">addons</span><span class="o">:</span>
  <span class="n">apt</span><span class="o">:</span>
    <span class="n">packages</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">language</span><span class="o">-</span><span class="n">pack</span><span class="o">-</span><span class="n">en</span><span class="o">-</span><span class="n">base</span>
<span class="n">python</span><span class="o">:</span>
<span class="o">-</span> <span class="mf">3.6</span><span class="o">.</span><span class="mi">5</span>
<span class="n">branches</span><span class="o">:</span>
  <span class="n">except</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">master</span>
<span class="n">install</span><span class="o">:</span>
<span class="o">-</span> <span class="n">pip</span> <span class="n">install</span> <span class="s1">'Nikola[extras]'</span><span class="o">==</span><span class="mf">8.0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">b2</span>
<span class="n">script</span><span class="o">:</span>
<span class="o">-</span> <span class="n">nikola</span> <span class="n">build</span> 
</pre>


<p>First 9 lines: Nikola is written in python, it is why we need it in, at least, version 3. 
Travis should ignore any changes on master branch (he will do them himself after all), that's the 
reason for excepting branch master. First, we have to install Nikola using pip. I forced 
version 8.0.0.b2 for its built-in theme. By default, <strong>pip</strong> installs version 7 of Nikola. After all 
this 'work' there is time for build script: <code>nikola build</code>.</p>
<p>Ok, so now we have our site build. How deploy it on GitHub Pages? One could play with <code>nikola deploy</code> 
or a few <code>git</code> commands, but Travis has a deploy provider for that:</p>
<pre class="code literal-block"><span></span><span class="n">deploy</span><span class="o">:</span>
    <span class="n">provider</span><span class="o">:</span> <span class="n">pages</span>
    <span class="n">skip</span><span class="o">-</span><span class="n">cleanup</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">keep</span><span class="o">-</span><span class="n">history</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">github</span><span class="o">-</span><span class="n">token</span><span class="o">:</span> <span class="n">$GITHUB_TOKEN</span>
    <span class="n">local</span><span class="o">-</span><span class="n">dir</span><span class="o">:</span> <span class="n">output</span>
    <span class="n">target</span><span class="o">-</span><span class="n">branch</span><span class="o">:</span> <span class="n">master</span>
    <span class="n">verbose</span><span class="o">:</span> <span class="kc">true</span>
    <span class="n">repo</span><span class="o">:</span> <span class="n">death</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">rats</span><span class="o">/</span><span class="n">death</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">rats</span><span class="o">.</span><span class="na">github</span><span class="o">.</span><span class="na">io</span>
    <span class="n">on</span><span class="o">:</span>
        <span class="n">branch</span><span class="o">:</span> <span class="n">source</span>
</pre>


<p>More information could be found at <a href="https://docs.travis-ci.com/user/deployment/pages/">TCI01</a>. 
I added <code>local-dir</code> to set what should be deployed and where (<code>repo</code> and <code>target-branch: master</code>). 
This operation should take place on <em>source</em> branch.</p>
<p>In GitHub <em>Settings &gt; Developer settings &gt; Personal access tokens</em> <code>Generate new token</code> for Travis. 
At <a href="https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/">GH01</a> 
you can read what to do. This token insert in Travis settings Environment Variables and use it by 
<em>$VariableName</em>. </p>
<p>Ok, now is the time to push changes and watch how Travis is building and deploying <strong>Your</strong> site.</p>
<p>Easy, I almost forget about that 4 hours of tries...</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/github-%2B-nikola/" class="u-url">0x01 github + nikola</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/github-%2B-nikola/" rel="bookmark"><time class="published dt-published" datetime="2018-05-21T07:00:30Z" title="2018-05-21 07:00">2018-05-21 07:00</time></a></p>
                        <p class="commentline">
        
    <a href="posts/github-%2B-nikola/#disqus_thread" data-disqus-identifier="cache/posts/github-+-nikola.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<p>How to start GitHub repo for hosting pages with Nikola. I want a branch (let us name it <code>source</code>) where I will keep my project. I plan to generate static files to some folder and push it to the <code>master</code> branch. In other words, <code>master</code> branch will have my site and <code>source</code> branch will have the whole Nikola engine with my source files.</p>
<p>I need to create new repo: <em><username>.github.io</username></em> on GitHub page. Next, I will clone it to the local folder, make my branch and push it.</p>
<pre class="code literal-block"><span></span>git clone git@github.com:death-of-rats/death-of-rats.github.io.git
<span class="nb">cd</span> death-of-rats.github.io.git
git commit --allow-empty -am <span class="s2">"start using repo"</span>
git branch <span class="nb">source</span>
git checkout <span class="nb">source</span>
git push --set-upstream origin <span class="nb">source</span>
</pre>


<p>And I have the empty repo with 2 branches.</p>
<p>Now I init the Nikola project in repo root folder (on branch <code>source</code>). Nikola will produce html files to the <code>output</code> folder so I need, after the first test run, split subtree for that folder and push it to <code>master</code>:</p>
<pre class="code literal-block"><span></span>git push origin <span class="sb">`</span>git subtree split --prefix output/ master<span class="sb">`</span>:master --force
</pre>


<p>It's almost done. Manual deploy command may look like this:</p>
<pre class="code literal-block"><span></span>git add -A
git commit -m <span class="s2">"&lt;deploy message for commit&gt;"</span> -S
git push origin <span class="nb">source</span>
git subtree push --prefix output/ origin master
</pre>


<p>What have I missed? I didn't add <code>.gitignore</code>...</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/std%3A%3Amake_shared/" class="u-url">0x00 std::make_shared</a></h1>
                <div class="metadata">
                    <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                        death-of-rats
                    </span></p>
                    <p class="dateline"><a href="posts/std%3A%3Amake_shared/" rel="bookmark"><time class="published dt-published" datetime="2018-05-21T00:35:21Z" title="2018-05-21 00:35">2018-05-21 00:35</time></a></p>
                        <p class="commentline">
        
    <a href="posts/std%3A%3Amake_shared/#disqus_thread" data-disqus-identifier="cache/posts/make_shared.html">Comments</a>


                </p>
</div>
            </header><div class="e-content entry-content">
                    <div>
<h3>This is the place...</h3>
<p>... where I dump my RAM - thoughts I don't want to lose. </p>
<pre class="code literal-block"><span></span><span class="k">auto</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">Place</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Blog</span><span class="o">&gt;</span><span class="p">();</span>
</pre>


<p>It's some start... not necessarily a good one.</p>
<p>...<strong>SQUEAK</strong>!</p>
</div>
                </div>
            </article>
</div>
    

    
        
       <script>var disqus_shortname="death-of-rats-github-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><!--End of body content--><footer id="footer">
            Contents © 2019         death-of-rats - powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons Licence" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/80x15.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br><img src="https://travis-ci.org/death-of-rats/death-of-rats.github.io.svg?branch=source"></footer>
</div>
</div>


        <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('a.reference:not(.islink)', {
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    baguetteBox.run('img:not(.islink)', {
        captions: function(element) {
            return element.alt;
    }});
    </script>
</body>
</html>
